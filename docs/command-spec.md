# コマンド仕様書   
**version**: 0.1  
**status**: Draft  
**Author**: connor252

---

## 1. 目的

本仕様書は、音声認識によってテキスト化された入力文を、  
「キャラ操作コマンド」として解釈し、処理（実行/返答）に落とすためのルールを定義する。

v1では、実機を使わず **PC上でのデモ実行**（モニター演出）を対象とする。

---

## 2. State Model(状態)

本プロジェクトは複数キャラを扱うが、基本方針として **同時にアクティブにするのは1体**とする。

- **IDLE**：アクティブキャラが存在しない状態
- **ACTIVE**：アクティブキャラが1体存在する状態

---

## 3. コマンド種別

### 3.1 Public
クラスキャラ固有の振る舞い・演出や、キャラを介したデバイス操作。

- **挨拶 / 反応**：おはよう、ただいま、おやすみ など
- **デバイス操作**：電気つけて/消して、色変えて、明るく/暗く など
- **システム応答**：ヘルプ、未対応案内 など

### 3.2 Private
キャラ固有の振る舞い・演出や、キャラを介したデバイス操作。

- **デバイス操作**：ライトの色
- **演出**：セリフ、テーマカラー、モーション/表情
- 

---

## 4. 入力フォーマット

### 基本 : 「キャラ名 + コマンド」
最優先の基本操作。

例:  
- 「スライム 電気をつけて」
- 「スライム ライトを〇〇色にして」
- 「スライム 電気OFF」

区切り：  
- 空白 / 「、」 / 句読点は等価として扱う（解析前に正規化する）

### 単一 : 「コマンド」
キャラ名が含まれない、一単語で成立するコマンド。

例:  
- 「おはよう」
- 「ただいま」
- 「おやすみ」

単一コマンド時の返答主体：
- `ACTIVE` が存在 → そのキャラが返答
- `IDLE` の場合 → システムが返答

---

## 5. 解析ルール
入力文を正規化した後、以下の優先順位で解釈する。

### 5.1 正規化（Normalization）
- 区切り文字（空白 / 「、」 / `,` / `.` 等）をスペースに統一
- 連続スペースは1つに圧縮
- 全角/半角の揺れは可能なら吸収（v1は最低限でも可）

### 5.2 優先順位（Priority）
1) **単一コマンド辞書（挨拶など）に完全一致**  
   - 宛先：`ACTIVE` があればそのキャラ、なければ system
   - 例：「おはよう」→ `GREETING_MORNING`

2) 先頭トークンが **登録キャラ名に一致**  
   - 形式：`{character} + {command...}`
   - `{command...}` をそのキャラの命令として処理
   - 成功時：`ACTIVE(character)` に更新し、`last_active_character` も更新

3) それ以外  
   - system/public として処理（未対応なら UNKNOWN 扱い）
   - 例：「状態教えて」→ `STATUS`（v1では任意）
   - 例：意味不明な文 → UNKNOWN

---

## 6. エラー処理

v1では、エラーを「ユーザーが次に何を言えば良いか」まで返す。

- **UNKNOWN_CHARACTER**：キャラ名が未登録  
  例：「○○ 電気つけて」→「キャラが未登録です：○○。候補：デュラハン / スライム」

- **UNKNOWN_COMMAND**：未対応の命令  
  例：「デュラハン 踊って」→「未対応コマンド：踊って。例：電気つけて / 色を青にして」

- **REJECTED_BY_STATE**：状態的に実行不可  
  例：ACTIVE必須の処理をIDLEで要求（※v1では少なめ）

- **PARSE_ERROR**：空入力、無音、解析不能  
  例：「もう一度お願いします」

返答方針（v1）：
- 必ず「理由 + 例（使える言い方）」を返す

---

## 7. v2/v3(予定)

- **v2 : 実機・AWS連携**
  - Raspberry Pi / LED / センサー等の実機ドライバ追加
  - AWS（IoT Core / Lambda など）との接続
  - スマホアプリでの基本操作

- **v3 : 運用(長時間,整理,制限)**
  - 長時間稼働を前提にした整理（ログ、再起動、安定化）
  - コマンドや機能の見直し（増やすより「使うものだけ」に制限）
  - キャラ演出強化（モーション、反応、固有性の拡張）
